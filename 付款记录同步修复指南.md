# 付款记录同步修复指南

## 问题描述
付款记录没有被同步到云端，这是因为原始的数据库表结构中缺少付款记录相关的字段。

## 解决方案

### 第一步：更新数据库表结构
1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 选择您的项目
3. 在左侧菜单中点击 **"SQL Editor"**
4. 点击 **"New query"** 创建新的 SQL 查询
5. 复制 `UPDATE_PAYMENT_FIELDS.sql` 文件中的所有内容
6. 粘贴到 SQL 编辑器中
7. 点击 **"Run"** 按钮执行 SQL 脚本

### 第二步：验证表结构更新
执行完 SQL 脚本后，您应该看到：
- ✅ 字段 `paid_amount` 添加成功
- ✅ 字段 `payments` 添加成功
- ✅ 索引创建成功
- ✅ 现有记录更新成功

### 第三步：测试付款记录同步
1. 刷新浏览器页面重新加载系统
2. 添加一条新的收账记录
3. 为该记录添加付款记录
4. 等待30秒让自动同步生效，或点击手动同步按钮
5. 点击 **"从云端加载"** 按钮验证数据是否正确同步

## 修复内容

### 数据库表结构更新
- 添加 `paid_amount` 字段：存储已付金额
- 添加 `payments` 字段：存储付款记录详情（JSON格式）
- 创建相应索引提高查询性能

### 同步逻辑修复
- **manualSync函数**：现在会同步 `paidAmount` 和 `payments` 字段到云端
- **loadFromCloud函数**：现在会从云端加载付款记录信息
- **自动同步**：每30秒自动同步包含付款记录的完整数据

## 付款记录数据结构

付款记录以JSON数组格式存储在 `payments` 字段中：
```json
[
  {
    "id": "PAY_xxx",
    "date": "2024-01-15",
    "amount": 500.00,
    "method": "transfer",
    "remark": "首期付款",
    "createdAt": "2024-01-15T10:30:00.000Z"
  }
]
```

## 注意事项

1. **备份数据**：在执行SQL脚本前，建议先备份现有数据
2. **网络连接**：确保网络连接稳定，避免同步过程中断
3. **权限检查**：确保Supabase项目有足够的权限执行DDL操作
4. **数据一致性**：更新后首次同步可能需要较长时间，请耐心等待

## 故障排除

### 如果SQL执行失败
- 检查Supabase项目权限
- 确认表名 `debt_records` 是否正确
- 查看错误信息并根据提示调整

### 如果同步仍然失败
- 检查浏览器控制台是否有错误信息
- 验证Supabase配置是否正确
- 确认网络连接是否稳定

### 如果付款记录显示异常
- 清除浏览器缓存并重新加载
- 检查本地存储中的数据格式
- 重新从云端加载数据

## 完成确认

修复完成后，您应该能够：
- ✅ 添加付款记录后自动同步到云端
- ✅ 从云端正确加载包含付款信息的记录
- ✅ 在状态列中看到付款金额和剩余金额
- ✅ 查看详细的付款记录历史

如果遇到任何问题，请检查浏览器控制台的错误信息，或参考 `SUPABASE_数据库配置指南.md` 文件。